From 70d1a1a3ed64d7bd82fd90268e4c9cf208ca1be0 Mon Sep 17 00:00:00 2001
From: dan <dan@noemail.net>
Date: Wed, 20 Nov 2019 13:31:52 +0000
Subject: [PATCH] Further improve detection of corrupt records in fts3.

FossilOrigin-Name: a0f6d526baecd061a5e2bec5eb698fb5dfb10122ac79c853d7b3f4a48bc9f49b
---
 ext/fts3/fts3.c       |  2 +-
 ext/fts3/fts3_write.c |  2 +-
 manifest              | 16 ++++++++--------
 manifest.uuid         |  2 +-
 4 files changed, 11 insertions(+), 11 deletions(-)

--- a/ext/fts3/fts3.c
+++ b/ext/fts3/fts3.c
@@ -1973,7 +1973,7 @@ static int fts3SelectLeaf(
     if( rc==SQLITE_OK ){
       int iNewHeight = 0;
       fts3GetVarint32(zBlob, &iNewHeight);
-      if( iNewHeight<=iHeight ){
+      if( iNewHeight>=iHeight ){
         rc = FTS_CORRUPT_VTAB;
       }else{
         rc = fts3SelectLeaf(p, zTerm, nTerm, zBlob, nBlob, piLeaf, piLeaf2);
--- a/ext/fts3/fts3_write.c
+++ b/ext/fts3/fts3_write.c
@@ -1376,7 +1376,7 @@ static int fts3SegReaderNext(
   pNext += fts3GetVarint32(pNext, &nSuffix);
   if( nSuffix<=0 
    || (&pReader->aNode[pReader->nNode] - pNext)<nSuffix
-   || nPrefix>pReader->nTermAlloc
+   || nPrefix>pReader->nTerm
   ){
     return FTS_CORRUPT_VTAB;
   }
