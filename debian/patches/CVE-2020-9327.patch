Backport of:

From 78d1d225d87af40f5bdca57fa72f00b6ffaffa21 Mon Sep 17 00:00:00 2001
From: drh <drh@noemail.net>
Date: Mon, 17 Feb 2020 19:25:07 +0000
Subject: [PATCH] A better (smaller and faster) solution to ticket
 [4374860b29383380].

FossilOrigin-Name: abc473fb8fb999005dc79a360e34f97b3b25429decf1820dd2afa5c19577753d
---
 manifest        | 16 ++++++++--------
 manifest.uuid   |  2 +-
 src/expr.c      | 25 +++++++++++--------------
 src/sqliteInt.h |  4 +++-
 src/whereexpr.c | 12 ++++++++----
 5 files changed, 31 insertions(+), 28 deletions(-)

--- a/src/sqliteInt.h
+++ b/src/sqliteInt.h
@@ -1939,8 +1939,11 @@ struct Table {
 */
 #ifndef SQLITE_OMIT_VIRTUALTABLE
 #  define IsVirtual(X)      ((X)->nModuleArg)
+#  define ExprIsVtab(X)  \
+              ((X)->op==TK_COLUMN && (X)->pTab!=0 && (X)->pTab->nModuleArg)
 #else
 #  define IsVirtual(X)      0
+#  define ExprIsVtab(X)     0
 #endif
 
 /*
--- a/src/whereexpr.c
+++ b/src/whereexpr.c
@@ -362,7 +362,7 @@ static int isAuxiliaryVtabOperator(
       return 0;
     }
     pCol = pList->a[1].pExpr;
-    if( pCol->op!=TK_COLUMN || !IsVirtual(pCol->pTab) ){
+    if( !ExprIsVtab(pCol) ){
       return 0;
     }
     for(i=0; i<ArraySize(aOp); i++){
@@ -377,10 +377,10 @@ static int isAuxiliaryVtabOperator(
     int res = 0;
     Expr *pLeft = pExpr->pLeft;
     Expr *pRight = pExpr->pRight;
-    if( pLeft->op==TK_COLUMN && IsVirtual(pLeft->pTab) ){
+    if( ExprIsVtab(pLeft) ){
       res++;
     }
-    if( pRight && pRight->op==TK_COLUMN && IsVirtual(pRight->pTab) ){
+    if( pRight && ExprIsVtab(pRight) ){
       res++;
       SWAP(Expr*, pLeft, pRight);
     }
