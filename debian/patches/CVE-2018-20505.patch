Description: Assertion fault due to malformed PRIMARY KEY
Origin: https://sqlite.org/src/vpatch?from=caebf8792576752d&to=1309c84ad36b6ac6
Bug-Debian: https://security-tracker.debian.org/tracker/CVE-2018-20505
---
 src/wherecode.c    |  2 +-
 test/rowvalue.test | 11 +++++++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/wherecode.c b/src/wherecode.c
index 32dd204..1b7153a 100644
--- a/src/wherecode.c
+++ b/src/wherecode.c
@@ -426,7 +426,7 @@ static Expr *removeUnindexableInClauseTerms(
     for(i=iEq; i<pLoop->nLTerm; i++){
       if( pLoop->aLTerm[i]->pExpr==pX ){
         int iField = pLoop->aLTerm[i]->iField - 1;
-        assert( pOrigRhs->a[iField].pExpr!=0 );
+        if( pOrigRhs->a[iField].pExpr==0 ) continue; /* Duplicate PK column */
         pRhs = sqlite3ExprListAppend(pParse, pRhs, pOrigRhs->a[iField].pExpr);
         pOrigRhs->a[iField].pExpr = 0;
         assert( pOrigLhs->a[iField].pExpr!=0 );
diff --git a/test/rowvalue.test b/test/rowvalue.test
index 5f2701c..88e171e 100644
--- a/test/rowvalue.test
+++ b/test/rowvalue.test
@@ -394,4 +394,15 @@ do_execsql_test 16.5 {
   3 i ii iii iv
 }
 
+# 2018-11-03: Ticket https://www.sqlite.org/src/info/1a84668dcfdebaf1
+# Assertion fault when doing row-value operations on a primary key
+# containing duplicate columns.
+#
+do_execsql_test 21.0 {
+  DROP TABLE IF EXISTS t1;
+  CREATE TABLE t1(a,b,PRIMARY KEY(b,b));
+  INSERT INTO t1 VALUES(1,2),(3,4),(5,6);
+  SELECT * FROM t1 WHERE (a,b) IN (VALUES(1,2));  
+} {1 2}
+
 finish_test
-- 
2.21.0

